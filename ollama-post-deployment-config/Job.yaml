---
apiVersion: batch/v1
kind: Job
metadata:
  name: ollama-post-deployment-config
  annotations:
    fluxcd.io/restart: "2024-12-01T12:00:05Z"
  namespace: ollama
spec:
  template:
    spec:
      containers:
        - name: ollama-post-deployment-config
          image: alpine/k8s:1.30.6
          command:
            - /bin/sh
            - -c
            - |
              USERNAME=$(kubectl get secret fortiweb-login-secret -o jsonpath="{.data.username}" | base64 -d)
              PASSWORD=$(kubectl get secret fortiweb-login-secret -o jsonpath="{.data.password}" | base64 -d)
              if [ -z "$USERNAME" ] || [ -z "$PASSWORD" ]; then
                echo "Error: Could not retrieve username or password from the secret."
                exit 1
              fi
              TOKEN=$(echo "{\"username\":\"$USERNAME\",\"password\":\"$PASSWORD\",\"vdom\":\"root\"}" | base64 | tr -d "\\n")
              curl 'https://10.0.0.4/api/v2.0/cmdb/server-policy/policy?mkey=ollama_ollama' \
              --insecure \
              -H "Authorization:$TOKEN" \
              -k \
              -X 'PUT' \
              -H 'Content-Type: application/json;charset=utf-8' \
              -H 'Accept: application/json, text/plain, */*' \
              -H 'Accept-Encoding: gzip, deflate, br' \
              -H 'Connection: keep-alive' \
              --data-binary '{"data":{"intermediate-certificate-group":"letsencrypt-ca-group"}}'
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
      restartPolicy: OnFailure
  backoffLimit: 40
